# UI要件定義（改善版）

## 1. 画面レイアウト構成（Z軸レイヤー順）

画面を奥から手前へ以下のレイヤー構造で管理する。

### レイヤー構造

| レイヤー名 | Z-Index範囲 | 説明 | 優先度 |
|-----------|------------|------|--------|
| **Background Layer** | 0-99 | 背景（3Dモデルまたは書き割り） | P0 |
| **Board Layer** | 100-199 | ユニット配置スロット（3レーン）、グリッド表示 | P0 |
| **Unit Layer** | 200-299 | 配置されたキャラクター（Live2Dまたは3Dモデル） | P0 |
| **Effect Layer (World)** | 300-399 | 攻撃時の火花、斬撃などのワールドエフェクト | P1 |
| **HUD Layer** | 400-499 | プレイヤーHP、MPゲージ、手札カード | P0 |
| **Overlay Layer** | 500-599 | 「Active Response」等の暗転演出、カットイン | P0 |
| **Modal Layer** | 600-699 | カード詳細ポップアップ、設定画面 | P1 |
| **System Layer** | 700-799 | 設定ボタン、通信切断アイコン、デバッグ表示 | P2 |

### 実装上の注意事項

- 各レイヤーは独立したCanvas/Containerとして管理
- パフォーマンス最適化のため、非表示レイヤーは描画をスキップ
- モバイル/PCでレイヤー構造は同一だが、解像度に応じてスケーリング

---

## 2. HUD（Heads-Up Display）機能

### 2.1 プレイヤー/敵ヒーロー情報

#### HPバー

**要件:**
- 即時変動ではなく、ダメージ分が赤く残ってから減る「遅延減少処理」を実装
- ダメージを受けた際の視覚的フィードバック

**技術仕様:**
- **即時表示**: 新しいHP値（緑/青のバー）
- **遅延表示**: ダメージ量（赤いバー）が0.5秒かけて減少
- **アニメーションカーブ**: EaseOutCubic（最初は速く、徐々に遅く）
- **最大HP更新時**: バー全体がスムーズに拡張（0.3秒）

**実装例（疑似コード）:**
```
HP変化時:
  1. 新しいHP値を即座に反映（現在HPバーを更新）
  2. 前回HP値との差分を赤い「ダメージバー」として表示
  3. 0.5秒かけて赤いバーを徐々に減らす（アニメーション）
  4. 赤いバーが0になったら非表示
```

#### ヒーローアーツ（必殺技）インジケーター

**要件:**
- APポイント蓄積によるグロー（発光）エフェクト
- 満タン時は強調表示

**技術仕様:**
- **AP値表示**: 0/10 の数値表示
- **グローエフェクト**: 
  - AP 0-5: 通常表示
  - AP 6-9: パルス発光（1秒周期）
  - AP 10: 強烈な発光 + パーティクルエフェクト
- **発動可能時**: 「発動」ボタンをハイライト + 振動（モバイル）

---

### 2.2 MP（マナ）ゲージ

#### 基本要件

**回復速度:**
- 時間経過でリニアに増加（2秒で1MP）
- サーバー同期を考慮した表示（ラグ補正）

**視覚的表現:**
- グラデーションバー（空: グレー、満タン: 属性色）
- 現在値/最大値を数値表示（例: 3/10）

#### インタラクティブフィードバック

**要件: 使用可能カード通知**

- 現在の手札で使用可能なカードがある場合、該当コストまで溜まった瞬間にSEと光のエフェクトを発火

**技術仕様:**
- **判定ロジック**: 
  ```
  手札内の各カードについて:
    if (currentMP + blueMP >= card.cost && card.costが最小値) {
      通知を発火
    }
  ```
- **エフェクトタイミング**: MPが目標値に到達したフレーム
- **エフェクト内容**:
  - SE: 短いチャイム音（0.2秒）
  - VFX: 手札エリアの背景が一瞬光る（0.3秒）
  - 使用可能カード: カード枠にグローエフェクト（持続）
- **連続通知防止**: 同一コスト到達時は1回のみ通知（3秒間クールダウン）

---

### 2.3 手札エリア（Hand）

#### 基本仕様

- **最大保持数**: 5枚（想定、ゲームロジックで調整可能）
- **表示位置**: 画面下部中央
- **カードサイズ**: 
  - PC: 幅120px、高さ160px
  - モバイル: 幅80px、高さ110px（画面サイズに応じてスケーリング）

#### 整列ロジック

**要件: カード枚数に応じて中央揃えで均等配置**

**技術仕様:**
```
カード枚数: N
画面幅: W
カード幅: CARD_WIDTH
カード間隔: GAP (デフォルト: 10px)

総幅: totalWidth = N * CARD_WIDTH + (N-1) * GAP
開始位置: startX = (W - totalWidth) / 2

各カードの位置:
  card[i].x = startX + i * (CARD_WIDTH + GAP)
```

**追加要件:**
- カード追加/削除時はスムーズな移動アニメーション（0.3秒）
- ドラッグ中のカードは一時的に手札から除外（位置計算に含めない）

#### ドラッグ操作

**Hold（タップ長押し）**

- **判定時間**: 0.5秒長押し
- **動作**: カード詳細ポップアップ表示
- **キャンセル**: 指を離すとポップアップを閉じる
- **モバイル最適化**: 誤タップ防止のため、0.5秒未満のタップでは反応しない

**Drag（ドラッグ）**

- **開始判定**: カード上でドラッグ開始（移動距離5px以上）
- **状態遷移**: 画面中央へドラッグで「使用予兆」状態へ移行
- **使用予兆表示**:
  - ドラッグ中のカード: 1.2倍に拡大 + 半透明
  - 有効なスロット: グローエフェクト（点滅）
  - 無効なスロット: グレーアウト
- **MP不足時**: カードを赤く表示 + 「MP不足」テキスト

**Drop（ドロップ）**

- **有効エリア判定**:
  - ユニットカード: 空いているレーンスロット上
  - アクションカード: 画面中央エリア（どこでも可）
- **成功時**:
  - カードがスロットへ移動（0.3秒アニメーション）
  - 召喚エフェクト発動
  - 手札からカードを削除
- **失敗時（無効エリア）**:
  - カードが手札に戻る（バウンスアニメーション、0.4秒）
  - SE: 短い警告音

---

## 3. 盤面（Board）相互作用

### 3.1 ユニットスロット（3レーン）

#### レーン構成

- **レーン数**: 3本（0, 1, 2）
- **配置**: 横並び（左: レーン0、中央: レーン1、右: レーン2）
- **スロットサイズ**: 
  - PC: 200px × 300px
  - モバイル: 120px × 180px

#### 攻撃矢印（Attack Arrow）

**要件: 味方ユニットから敵ユニットへ伸びる矢印**

**技術仕様:**
- **描画方法**: ベジェ曲線（Bezier Curve）描画
- **曲線計算**:
  ```
  開始点: (unit1.x, unit1.y + unit1.height/2)
  終了点: (unit2.x, unit2.y + unit2.height/2)
  制御点1: (unit1.x + distance * 0.3, unit1.y - 50)
  制御点2: (unit2.x - distance * 0.3, unit2.y - 50)
  ```
- **動的調整**: ユニット間の距離に応じて曲線の高さを調整（距離が近いほど低く）
- **視覚的表現**:
  - 矢印の太さ: 3px（通常）、5px（必殺技）
  - 色: 属性色（ユニットの属性に応じて）
  - アニメーション: 矢印が流れるパーティクル（0.5秒周期）

**衝突判定とヒットストップ**

- **到達判定**: 矢印の先端が敵ユニットのコリジョンに到達した瞬間
- **ヒットストップ**: 
  - 通常攻撃: 0.05秒（3フレーム @ 60fps）
  - 必殺技: 0.15秒（9フレーム @ 60fps）
- **実装方法**: TimeScaleを0.1に変更 → 指定時間後に1.0に復帰

---

### 3.2 Active Response（割り込みフェーズ）UI

#### トリガー条件

- アクションカード使用時
- フェーズ遷移: `playing` → `activeResponse`

#### 演出要件

**背景暗転（Dim）**

- **実装**: 画面全体に半透明の黒いオーバーレイ（alpha: 0.7）
- **アニメーション**: フェードイン（0.3秒）
- **盤面停止**: ゲームロジックのTimeScaleを0に設定（ただしARタイマーは進行）

**ターンタイマーバー**

- **表示位置**: 画面中央上部
- **デザイン**: 横長のバー（幅: 画面幅の60%、高さ: 8px）
- **カウントダウン**: 10秒 → 0秒（リニア減少）
- **視覚的表現**:
  - 残り時間 > 5秒: 緑色
  - 残り時間 5-2秒: 黄色
  - 残り時間 < 2秒: 赤色 + パルス
- **時間切れ時**: 自動でパス扱い（最後に出したプレイヤーが勝ち）

**チェーンUIアニメーション**

- **要件**: カード同士を「チェーン」として線で繋ぐUI
- **描画方法**: 
  - カード間を線で接続（ベジェ曲線）
  - カードが追加されるたびに線を延長
- **アニメーション**:
  - 新規カード追加: カードが中央に出現（0.3秒）→ 線が伸びる（0.2秒）
  - 解決時: 下から順にカードが消える（0.2秒間隔）

**状態遷移**

- **カードプレイ**: AR中のアクションカードをプレイ可能
- **パスボタン**: 画面下部に表示、タップでパス
- **解決条件**: 
  - 両プレイヤーが連続でパス
  - タイマー切れ
  - スタックが空で片方がパス

---

## 4. フィードバック（Juice / Game Feel）

### 4.1 シェイク（Screen Shake）

**要件: ヒーローがダメージを受けた際、カメラ全体をXY軸にランダムに振動させる**

**技術仕様:**
- **トリガー**: プレイヤーHP減少時
- **振動パターン**: Perlin Noise または ランダム振動
- **パラメータ**:
  - **強度**: ダメージ量に比例（最大: 10px）
  - **継続時間**: 0.3秒
  - **減衰**: 指数関数的に減衰
- **実装方法**: カメラ位置にオフセットを追加（毎フレーム更新）

**注意事項:**
- モバイルではパフォーマンスを考慮して強度を下げる（最大: 5px）
- エピレプシー対策: 設定でOFFにできるオプションを用意

---

### 4.2 ヒットストップ

**要件: 強い攻撃が当たった瞬間、ゲーム全体の進行を0.1秒ほど停止させ、重みを表現**

**技術仕様:**
- **適用条件**:
  - 通常攻撃: ダメージが20以上
  - 必殺技: 常に適用
- **実装方法**: 
  - TimeScaleを0.1に変更（0.1秒間）
  - エフェクトは通常速度（TimeScaleの影響を受けない）
- **視覚的補足**: ヒット時に画面を一瞬白くフラッシュ（0.05秒）

---

### 4.3 ダメージフローティングテキスト

**要件: ダメージ数値を敵キャラクターの手前にポップさせ、重力に従って落下・フェードアウトさせる**

**技術仕様:**
- **表示位置**: ダメージを受けたユニット/ヒーローの上部
- **フォント**: 太字、サイズ: 32px（ダメージ量に応じてスケール）
- **色**:
  - 通常ダメージ: 白
  - クリティカル: 黄色（1.5倍サイズ）
  - 回復: 緑
- **アニメーション**:
  - 上方向に移動（0.5秒、50px上昇）
  - 同時にフェードアウト（alpha: 1.0 → 0.0）
  - 重力効果: 最初は速く、徐々に遅くなる（EaseOut）
- **同時表示**: 複数のダメージが同時でも重ならないように配置（Y軸オフセット）

---

### 4.4 カードプレイ時のVFX

**要件: カードがユニットに実体化する際、単なるフェードインではなく、「召喚エフェクト（光の柱など）」を挟む**

**技術仕様:**
- **エフェクトシーケンス**:
  1. カードが手札から中央へ移動（0.2秒）
  2. カードが回転しながら拡大（0.3秒、1.0倍 → 1.5倍）
  3. 召喚エフェクト発動（光の柱、0.5秒）
  4. ユニットがエフェクト中央から出現（0.4秒、フェードイン）
  5. エフェクトがフェードアウト（0.2秒）
- **エフェクト詳細**:
  - 光の柱: パーティクルエフェクト（100-200パーティクル）
  - 色: カードの属性色
  - 高さ: スロットの高さ + 100px
- **パフォーマンス最適化**: モバイルではパーティクル数を50%に削減

---

## 5. 追加要件（改善点）

### 5.1 パフォーマンス要件

- **目標FPS**: 60fps（PC）、30fps以上（モバイル）
- **描画最適化**: 
  - 画面外のエフェクトは描画をスキップ
  - パーティクルシステムの上限設定（同時表示: 最大500）
- **メモリ管理**: 
  - エフェクトはオブジェクトプールを使用
  - 未使用のアセットは適宜アンロード

### 5.2 エラーハンドリング

- **ネットワークエラー**: 
  - 通信切断時は「再接続中...」表示
  - 5秒以上接続できない場合は「接続エラー」ダイアログ
- **操作エラー**:
  - 無効な操作時はSEで通知（視覚的なフィードバックも）
  - エラーメッセージは簡潔に（例: 「MPが足りません」）

### 5.3 アクセシビリティ

- **色覚対応**: 色だけでなく形状でも区別できるUI（例: 属性アイコン）
- **フォントサイズ**: 設定で調整可能（最小: 12px、最大: 24px）
- **操作支援**: 
  - タップ領域を十分に確保（最小: 44px × 44px）
  - 長押し操作の代替手段（設定画面から変更可能）

### 5.4 状態管理

- **UI状態**: ゲームロジック（core/）から独立
- **同期**: ゲーム状態が更新されたらUIを更新（一方向データフロー）
- **アニメーション状態**: UI層で管理（ゲームロジックの状態とは分離）

### 5.5 プラットフォーム固有の考慮

**PC版:**
- マウス操作: クリック、ドラッグ&ドロップ
- キーボードショートカット（任意）: スペースキーでパス

**モバイル版:**
- タッチ操作: タップ、ロングタップ、ドラッグ
- 画面回転: 横向きのみ対応
- バッテリー配慮: 設定でエフェクト品質を下げられる

---

## 6. 実装優先度

### Phase 0（MVP: 最小実用製品）
- レイヤー構造（Background, Board, Unit, HUD）
- 基本HUD（HP, MP, 手札）
- カードドラッグ&ドロップ
- 基本的なエフェクト（最小限）

### Phase 1（UX向上）
- Active Response UI
- ダメージフローティングテキスト
- カードプレイVFX
- MP通知機能

### Phase 2（高度な演出）
- シェイク
- ヒットストップ
- 攻撃矢印のアニメーション
- チェーンUIアニメーション

### Phase 3（最適化・仕上げ）
- パフォーマンス最適化
- アクセシビリティ対応
- プラットフォーム固有の調整

---

## 7. テスト要件

### 7.1 機能テスト
- 各UI要素が正しく表示されるか
- ドラッグ&ドロップが正常に動作するか
- エフェクトが適切なタイミングで発動するか

### 7.2 パフォーマンステスト
- 目標FPSを維持できるか（負荷テスト）
- メモリリークがないか（長時間プレイテスト）

### 7.3 UXテスト
- 実際のプレイヤーに操作してもらい、フィードバックを収集
- 操作の直感性を確認

