# カード効果実装ドキュメント

このドキュメントでは、TEPPENゲームのカード効果システムの実装について詳しく説明します。

---

## 目次

1. [アーキテクチャ概要](#アーキテクチャ概要)
2. [ファイル構成](#ファイル構成)
3. [型定義](#型定義)
4. [効果の流れ](#効果の流れ)
5. [実装済み効果一覧](#実装済み効果一覧)
6. [未実装効果一覧](#未実装効果一覧)

---

## アーキテクチャ概要

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   CSVファイル    │────▶│  effectParser.ts │────▶│   Effect[]      │
│  (効果テキスト)  │     │  (テキスト解析)  │     │  (構造化データ) │
└─────────────────┘     └──────────────────┘     └────────┬────────┘
                                                         │
                                                         ▼
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   engine.ts     │────▶│    effects.ts    │────▶│   GameState     │
│  (効果発動)     │     │  (効果解決)      │     │   (状態更新)    │
└─────────────────┘     └──────────────────┘     └─────────────────┘
```

---

## ファイル構成

| ファイル | 役割 |
|---------|------|
| `core/types.ts` | 型定義（Effect, GameState, Unit など） |
| `core/effects.ts` | 効果解決システム本体 |
| `core/effectParser.ts` | CSVの効果テキストをパース |
| `core/csvLoader.ts` | CSVからカード定義を読み込み |
| `core/engine.ts` | ゲームエンジン（効果発動タイミング管理） |

---

## 型定義

### ステータス効果 (`StatusEffect`)

```typescript
export type StatusEffect =
  | 'rush'         // ラッシュ: 即座に攻撃可能
  | 'flight'       // フライト: 対空ユニット以外から無視
  | 'shield'       // シールド: 1回のダメージを無効化
  | 'agility'      // アジリティ: 攻撃間隔短縮
  | 'combo'        // コンボ: 追加攻撃
  | 'veil'         // ベール: 効果ダメージ無効
  | 'crush'        // クラッシュ: 貫通ダメージ
  | 'heavy_pierce' // ヘビーピアス: 重貫通
  | 'spillover'    // スピルオーバー: 余剰ダメージ
  | 'halt'         // 停止: 一定時間行動不能
  | 'seal'         // 封印: 効果無効化
```

### 効果トリガー (`EffectTrigger`)

```typescript
export type EffectTrigger =
  | 'when_played'     // プレイ時
  | 'attacking'       // 攻撃時
  | 'after_attack'    // 攻撃後
  | 'death'           // 破壊時
  | 'while_on_field'  // フィールド上で（常時発動）
  | 'decimate'        // 撃破時（敵を倒した時）
  | 'resonate'        // 共鳴時（紫属性特有）
  | 'revenge'         // 復讐時（黒属性特有）
  | 'ascended'        // 昇華時
  | 'unleash'         // 解放時
  | 'quest'           // クエスト時
  | 'growth'          // 成長時
  | 'memory'          // メモリー時
```

### 効果タイプ (`EffectType`)

```typescript
export type EffectType =
  | 'damage'         // ダメージ
  | 'heal'           // 回復
  | 'buff'           // バフ（攻撃力/HP増加）
  | 'debuff'         // デバフ（攻撃力/HP減少）
  | 'status'         // ステータス付与
  | 'draw'           // ドロー
  | 'explore'        // 探索（デッキから検索）
  | 'return_to_hand' // 手札に戻す
  | 'destroy'        // 破壊
  | 'seal'           // 封印
  | 'halt'           // 停止
  | 'mp_gain'        // MP獲得
  | 'ap_gain'        // AP獲得
  | 'transform'      // 変身
  | 'summon'         // 召喚
  | 'negate'         // 無効化
  | 'control'        // コントロール奪取
```

### 効果ターゲット (`EffectTarget`)

```typescript
export type EffectTarget =
  | 'self'                 // 自分自身
  | 'friendly_unit'        // 味方ユニット
  | 'enemy_unit'           // 敵ユニット
  | 'friendly_hero'        // 味方ヒーロー
  | 'enemy_hero'           // 敵ヒーロー
  | 'all_units'            // 全ユニット
  | 'all_friendly_units'   // 全味方ユニット
  | 'all_enemy_units'      // 全敵ユニット
  | 'unit_in_front'        // 正面のユニット
  | 'random_unit'          // ランダムユニット
  | 'random_friendly_unit' // ランダム味方ユニット
  | 'random_enemy_unit'    // ランダム敵ユニット
```

### 効果定義 (`Effect`)

```typescript
export interface Effect {
  type: EffectType           // 効果の種類
  trigger: EffectTrigger     // 発動条件
  target?: EffectTarget      // 対象
  value?: number             // 数値（ダメージ量など）
  status?: StatusEffect      // ステータス効果
  duration?: number          // 持続時間（秒）
  condition?: string         // 条件（JSON文字列）
  description?: string       // 説明
}
```

---

## 効果の流れ

### 1. CSVからカード読み込み時

```
CSVの「効果」列 → parseEffectText() → Effect[] → CardDefinition.effects
```

**例: バレッタ**
```
CSV: "<Rush> When placed on the field: Deal 4 damage split among all enemy units."
     ↓
Effect[]: [
  { type: 'status', trigger: 'when_played', status: 'rush' },
  { type: 'damage', trigger: 'when_played', target: 'all_enemy_units', value: 4 }
]
```

### 2. カードプレイ時（engine.ts）

```typescript
// ユニットカードをプレイした時
if (cardDef.effects) {
  const whenPlayedEffects = cardDef.effects.filter(
    (e) => e.trigger === 'when_played'
  )
  for (const effect of whenPlayedEffects) {
    const context: EffectContext = {
      gameState: newState,
      cardMap: cardDefinitions,
      sourceUnit: sourceUnitState,
      sourcePlayer: newState.players[playerIndex],
      events,
    }
    const result = resolveEffect(effect, context)
    newState = result.state
    events.push(...result.events)
  }
}
```

### 3. 効果解決（effects.ts）

```typescript
export function resolveEffect(
  effect: Effect,
  context: EffectContext
): { state: GameState; events: GameEvent[] } {
  switch (effect.type) {
    case 'damage':
      return resolveDamageEffect(effect, context)
    case 'heal':
      return resolveHealEffect(effect, context)
    case 'buff':
      return resolveBuffEffect(effect, context)
    // ... 他の効果タイプ
  }
}
```

---

## 実装済み効果一覧

### ✅ ダメージ効果 (`damage`)

**実装内容:**
- 敵ヒーローへのダメージ
- 敵ユニットへのダメージ
- ユニット破壊時の墓地送り

**対応ターゲット:**
- `enemy_hero`: 敵ヒーロー
- `unit_in_front`: 正面のユニット
- `random_enemy_unit`: ランダム敵ユニット

**コード:**
```typescript
function resolveDamageEffect(effect: Effect, context: EffectContext) {
  const damage = effect.value || 0
  
  if (effect.target === 'enemy_hero' && targetPlayer) {
    // ヒーローにダメージ
    const newHp = Math.max(0, targetPlayer.hp - damage)
    newState.players[playerIndex].hp = newHp
  } else if (targetUnit) {
    // ユニットにダメージ
    const newHp = Math.max(0, targetUnit.unit.hp - damage)
    if (newHp <= 0) {
      // ユニット破壊 → 墓地送り
    }
  }
}
```

---

### ✅ 回復効果 (`heal`)

**実装内容:**
- ヒーローHP回復
- ユニットHP回復（最大HPを超えない）

**対応ターゲット:**
- `friendly_hero`: 味方ヒーロー
- `random_friendly_unit`: ランダム味方ユニット

**コード:**
```typescript
function resolveHealEffect(effect: Effect, context: EffectContext) {
  const heal = effect.value || 0
  
  if (effect.target === 'friendly_hero') {
    const newHp = Math.min(targetPlayer.maxHp, targetPlayer.hp + heal)
  } else if (targetUnit) {
    const newHp = Math.min(targetUnit.unit.maxHp, targetUnit.unit.hp + heal)
  }
}
```

---

### ✅ バフ効果 (`buff`)

**実装内容:**
- 攻撃力増加
- HP増加（現在HP + 最大HP両方）

**コード:**
```typescript
function resolveBuffEffect(effect: Effect, context: EffectContext) {
  if (targetUnit) {
    const attackBuff = effect.value || 0
    targetUnit.attack += attackBuff
    targetUnit.hp += attackBuff
    targetUnit.maxHp += attackBuff
  }
}
```

---

### ✅ デバフ効果 (`debuff`)

**実装内容:**
- 攻撃力減少（0以下にならない）

**コード:**
```typescript
function resolveDebuffEffect(effect: Effect, context: EffectContext) {
  if (targetUnit) {
    const debuff = effect.value || 0
    const newAttack = Math.max(0, targetUnit.attack - debuff)
  }
}
```

---

### ✅ ドロー効果 (`draw`)

**実装内容:**
- デッキからカードを引く
- 手札に追加

**コード:**
```typescript
function resolveDrawEffect(effect: Effect, context: EffectContext) {
  const drawCount = effect.value || 1
  
  for (let i = 0; i < drawCount && deck.length > 0; i++) {
    const cardId = deck.shift()
    hand.push(cardId)
  }
}
```

---

### ✅ 破壊効果 (`destroy`)

**実装内容:**
- ユニット即時破壊
- 墓地送り

**コード:**
```typescript
function resolveDestroyEffect(effect: Effect, context: EffectContext) {
  if (targetUnit) {
    player.units = player.units.filter(u => u.id !== targetUnit.unit.id)
    player.graveyard.push(targetUnit.unit.cardId)
  }
}
```

---

### ✅ MP獲得効果 (`mp_gain`)

**実装内容:**
- MP増加（最大MPを超えない）

**コード:**
```typescript
function resolveMpGainEffect(effect: Effect, context: EffectContext) {
  const mpGain = effect.value || 0
  player.mp = Math.min(player.maxMp, player.mp + mpGain)
}
```

---

### ✅ AP獲得効果 (`ap_gain`)

**実装内容:**
- ヒーローアーツゲージ増加（最大10）

**コード:**
```typescript
function resolveApGainEffect(effect: Effect, context: EffectContext) {
  const apGain = effect.value || 0
  player.ap = Math.min(10, player.ap + apGain)
}
```

---

### ✅ ステータス効果 (`status`)

**実装内容:**
- ステータス付与（Rush, Flight, Shield など）
- パース時に認識

**パース対応:**
```typescript
const statusMap = {
  rush: 'rush',
  flight: 'flight',
  shield: 'shield',
  agility: 'agility',
  combo: 'combo',
  veil: 'veil',
  crush: 'crush',
  'heavy pierce': 'heavy_pierce',
  spillover: 'spillover',
  halt: 'halt',
  seal: 'seal',
}
```

---

## 未実装効果一覧

### ❌ 探索 (`explore`)
デッキから特定のカードを検索してEXポケットに追加

### ❌ 手札に戻す (`return_to_hand`)
フィールドのユニットをEXポケットに戻す

### ❌ 封印 (`seal`)
ユニットの効果を無効化

### ❌ 停止 (`halt`)
ユニットを一定時間行動不能にする

### ❌ 変身 (`transform`)
ユニットを別のユニットに変身させる

### ❌ 召喚 (`summon`)
新しいユニットをフィールドに召喚

### ❌ 無効化 (`negate`)
アクションカードを無効化

### ❌ コントロール奪取 (`control`)
敵ユニットのコントロールを奪う

---

## トリガー実装状況

| トリガー | 実装状況 | 説明 |
|---------|---------|------|
| `when_played` | ✅ | プレイ時に発動 |
| `attacking` | ✅ | 攻撃時に発動 |
| `after_attack` | ❌ | 攻撃後に発動 |
| `death` | ⚠️ | 破壊時に発動（簡易実装） |
| `while_on_field` | ❌ | 常時発動 |
| `decimate` | ❌ | 撃破時に発動 |
| `resonate` | ❌ | 共鳴時に発動 |
| `revenge` | ❌ | 復讐時に発動 |
| `ascended` | ❌ | 昇華時に発動 |
| `unleash` | ❌ | 解放時に発動 |
| `quest` | ❌ | クエスト時に発動 |
| `growth` | ❌ | 成長時に発動 |
| `memory` | ❌ | メモリー時に発動 |

---

## カード効果の追加方法

### 1. 新しい効果タイプを追加する場合

1. `effects.ts` に `EffectType` を追加
2. `resolveXxxEffect` 関数を作成
3. `resolveEffect` のswitch文に追加

### 2. 新しいトリガーを追加する場合

1. `effects.ts` に `EffectTrigger` を追加
2. `effectParser.ts` にパース処理を追加
3. `engine.ts` に発動タイミングの処理を追加

### 3. 新しいターゲットを追加する場合

1. `effects.ts` に `EffectTarget` を追加
2. 各 `resolveXxxEffect` 関数にターゲット処理を追加

---

## 今後の拡張予定

1. **ステータス効果の実際の動作実装**
   - Rush: 配置直後に攻撃ゲージを満タンにする
   - Flight: 対空以外のユニットからの攻撃を無視
   - Shield: 1回のダメージを0にする

2. **分割ダメージの実装**
   - `all_enemy_units` への分割ダメージ

3. **条件付き効果の実装**
   - 「敵ユニットがいない場合」などの条件

4. **成長・メモリー・クエストシステム**
   - カウンターの管理
   - レベルアップ時の効果発動

